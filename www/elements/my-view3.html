<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="shared-styles.html">

<link rel="import" href="global-services.html">

<dom-module id="my-view3">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      iron-form {
        padding: 20px;
        display: block;
        min-width: 700px;
      }

      paper-input, paper-button{
        display:inline-block;
        margin: 0px 30px;
        width: 120px;
      }

      .coinName{
        display:inline-block;
        padding: 8px;
        width: 50px;
      }


      .coinConfig{
        display: block;
        height:80px;
      }

      .limitConfig{
        padding-left: 40px;
        display: block;
        height: 80px;
      }

    </style>

    <div class="card">
      <div class="">策略参数设置</div>
      <iron-form>
        <form>
          <template is="dom-repeat" items="{{coins}}">
            <div class="coinConfig">
              <h3 class="coinName">[[item.name]]</h3>
              <paper-input name="open" type="number" label="开仓差价百分比" value="{{item.open}}" required alwaysFloatLabel>
                <div slot="suffix">%</div>
              </paper-input>
              <paper-input name="close" type="number" label="平仓差价百分比" value="{{item.close}}" required alwaysFloatLabel>
                <div slot="suffix">%</div>
              </paper-input>
              <paper-input name="amount" type="number" label="开仓金额" value="{{item.amount}}" required alwaysFloatLabel>
                <div slot="prefix">$</div>
              </paper-input>
              <paper-checkbox checked="{{item.checked}}">执行</paper-checkbox>
            </div>
          </template>
          <div>
            <div class="limitConfig">
              <div class="coinName"></div>
              <paper-input name="limitopen" type="number" label="开仓允许价差" value="{{limitopen}}" required alwaysFloatLabel>
                <div slot="suffix">%</div>
              </paper-input>
              <paper-input name="limitclose" type="number" label="强制平仓波动" value="{{limitclose}}" required alwaysFloatLabel>
                <div slot="suffix">%</div>
              </paper-input>
              <paper-button raised="true" on-click="dialogConfirm" id="launchBtn">启动</paper-button>
              </div>
          </div>
        </form>
      </iron-form>
    </div>
    <paper-dialog id="startConfirmDialog">
      <h2>确认配置</h2>
      <template is="dom-repeat" items="[[coins]]">
        <dom-if if="{{item.checked}}">
          <template>
            <p>货币 {{item.name}}  开仓差价百分比{{item.open}}%  平仓差价百分比{{item.close}}%</p>
          </template>
        </dom-if>
      </template>
      <p>开仓允许价差{{limitopen}}%  强制平仓波动{{limitclose}}%</p>
      <div class="buttons">
        <paper-button dialog-dismiss autofocus>取消</paper-button>
        <paper-button dialog-confirm on-click="onStart">确定</paper-button>
      </div>
    </paper-dialog>
    <paper-dialog id="stopConfirmDialog">
      <h2>提示</h2>
      <p>确认退出当前任务?</p>
      <div class="buttons">
        <paper-button dialog-dismiss autofocus>取消</paper-button>
        <paper-button dialog-confirm on-click="onStop">确定</paper-button>
      </div>
    </paper-dialog>
    <div class="card">
      <div>
        <h2>策略输出日志</h2>
        <pre>[[log]]</pre>
      </div>
    </div>
    <global-services id="globalServices"></global-services>
    <iron-ajax
      url="/task/start"
      body="{{config}}"
      method="post"
      content-type="application/json"
      handle-as="json"
      on-response="onStarted"
      last-response={{response}}
      debounce-duration="300" id="ajaxStart"></iron-ajax>
    <iron-ajax
      url="/task/stop"
      method="get"
      content-type="application/json"
      handle-as="json"
      on-response="onStopped"
      last-response={{response}}
      debounce-duration="300" id="ajaxStop"></iron-ajax>
  </template>

  <script>
    class MyView3 extends Polymer.Element {
      static get is() { return 'my-view3'; }
      static get properties(){
        return {
          coins:{
            type: Array,
            value: []
          },
          response: String,
          path: String,
          config: String,
          limitopen: {
            type: Number,
            value: 0.3,
          },
          limitclose: {
            type: Number,
            value: 30,
          },
          log: {
            type: String,
            value: "",
          },
          started: {
            type: Boolean,
            value: false,
          }
        };       
      }

      ready(){
        super.ready()
        this.coins = [
          // all value will divide 100
          {name: "eth", open:3, close:1.5, amount: 50, checked:false},
          {name: "btc", open:3, close:0.5, amount: 50, checked:false},
          {name: "ltc", open:3, close:1.5, amount: 50, checked:false},
        ]

      }

      dialogConfirm(){
        
        if(this.started == false){
          this.started = true
          this.$.startConfirmDialog.open()
        }else{
          this.started = false
          this.$.stopConfirmDialog.open()
        }


      }

      onStart(){

        this.$.launchBtn.innerHTML = "停止"
        this.$.launchBtn.style.backgroundColor = "red"

        var config = {}
        config.limitopen = parseFloat(this.limitopen)/100,
        config.limitclose = parseFloat(this.limitclose)/100,
        config.area = {}
        for(var i=0;i<this.coins.length;i++){
          if(this.coins[i].checked){

            config.area[this.coins[i].name] = {
              open: parseFloat(this.coins[i].open),
              close: parseFloat(this.coins[i].close),
              amount: parseFloat(this.coins[i].amount),
            }
            
          }
        }

        this.config = JSON.stringify(config)
        this.$.ajaxStart.generateRequest()
        this.$.globalServices.WebsocketSubscribe("okexdiff", function(message){
          this.log = (message + "\n" + this.log)
        }.bind(this))
      }

      onStop(){

        this.$.ajaxStop.generateRequest()
        this.$.globalServices.WebsocketUnsubscribe("okexdiff", function(message){
          this.log += (message + "\n")
        }.bind(this))
      }

      onStarted(){
        console.log("Started:" + JSON.stringify(this.response))
      }

      onStopped(){
        this.$.launchBtn.innerHTML = "启动"
        this.$.launchBtn.style.backgroundColor = "green"
        console.log("Stopped:" + JSON.stringify(this.response))
      }
    }

    window.customElements.define(MyView3.is, MyView3);
  </script>
</dom-module>
